<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TOUCAN - Ù…Ù†Ùˆ</title>
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
  <div class="header">
    <div class="brand">
      <div class="logo">T</div>
      <div>
        <div style="font-weight:800;font-size:18px">TOUCAN</div>
        <div style="font-size:13px;color:#ddd">Ù…Ù†ÙˆÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„ - Ø³ÙØ§Ø±Ø´ Ø¨Ø§ QR</div>
      </div>
    </div>
  </div>

  <div>
    <div style="margin-bottom:10px">
      <strong>Ù…ÛŒØ²:</strong> <span id="table-number-display">â€”</span>
    </div>

    <div id="food-grid" class="food-grid"></div>
  </div>

  <!-- floating cart -->
  <div id="cart" class="cart-floating" aria-live="polite">
    <div style="flex:1">
      <div style="font-weight:800">ÙØ§Ú©ØªÙˆØ± (<span id="cart-count">0</span>)</div>
      <div class="cart-list" id="cart-list"></div>
      <div style="margin-top:6px;font-weight:800">Ú©Ù„: <span id="cart-total">0</span> ØªÙˆÙ…Ø§Ù†</div>
    </div>
    <div class="cart-actions">
      <button id="send-whatsapp" class="send-btn">Ø§Ø±Ø³Ø§Ù„ Ø³ÙØ§Ø±Ø´ Ø¨Ù‡ ÙˆØ§ØªØ³â€ŒØ§Ù¾</button>
      <button id="clear-cart" class="send-btn" style="background:#eee;color:#000">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
    </div>
  </div>

  <!-- modal -->
  <div id="modal" class="modal" style="display:none">
    <div class="box" role="dialog" aria-modal="true">
      <h3>Ú†Ù†Ø¯ Ø´Ù…Ø§Ø±Ù‡ Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯</h3>
      <p>Ø³ÙØ§Ø±Ø´ Ø¨Ù‡ Ù‡Ø± Ø´Ù…Ø§Ø±Ù‡ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯. Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù‡Ù…Ù‡ Ø±Ø§ Ø¨Ø§ Ù‡Ù… Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.</p>
      <div id="recipient-list" style="display:flex;flex-direction:column;gap:8px;margin-top:12px"></div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-start">
        <button id="send-all" class="send-btn">Ø§Ø±Ø³Ø§Ù„ Ù‡Ù…Ù‡</button>
        <button id="close-modal" class="send-btn" style="background:#ddd;color:#000">Ø¨Ø³ØªÙ†</button>
      </div>
    </div>
  </div>

<script>
// menu.js - client side logic
(() => {
  const CSV_PATH = 'data/foods.csv';
  const PLACEHOLDER = 'assets/images/placeholder.png';
  const POLL_INTERVAL = 12000; // ms
  const table = getQueryParam('table') || localStorage.getItem('toucan_table') || 'â€”';
  document.getElementById('table-number-display').textContent = table;
  localStorage.setItem('toucan_table', table);

  let foods = []; // array of food objects
  let cart = {}; // id -> {id, en, fa, price, whatsapp, qty}

  function getQueryParam(name) {
    const params = new URLSearchParams(location.search);
    return params.get(name);
  }

  // CSV parser that handles quoted fields and commas inside quotes
  function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
    if(lines.length === 0) return [];
    function parseLine(line) {
      const res=[]; let cur=''; let inQ=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch==='"'){
          if(inQ && line[i+1]==='"'){ cur+='"'; i++; }
          else inQ=!inQ;
        } else if(ch===',' && !inQ){
          res.push(cur); cur='';
        } else { cur+=ch; }
      }
      res.push(cur);
      return res;
    }
    return lines.map(parseLine);
  }

  async function fetchFoods() {
    try {
      const resp = await fetch(CSV_PATH + '?t=' + Date.now());
      const text = await resp.text();
      const rows = parseCSV(text);
      foods = rows.map((r, idx) => {
        return {
          id: (r[0] || ('item-'+idx)).toString().trim() || ('item-'+idx),
          en: (r[0]||'').trim(),
          fa: (r[1]||'').trim(),
          ingredients: (r[2]||'').trim(),
          price: r[3] ? Number(String(r[3]).replace(/[^0-9.-]/g,'')) : 0,
          whatsapp: (r[4]||'').trim(),
          img_name: (r[5]||'').trim(),
          img_folder: (r[6]||'').trim()
        }
      }).filter(it => it.en || it.fa);

      reconcileCartWithFoods();
      renderFoods();
    } catch(e){
      console.error('failed to load CSV', e);
    }
  }

  function reconcileCartWithFoods(){
    for(const key in cart){
      const entry = cart[key];
      const match = foods.find(f => f.id === entry.id || f.en === entry.en || f.fa === entry.fa);
      if(match){
        entry.price = match.price;
        entry.en = match.en;
        entry.fa = match.fa;
        entry.whatsapp = match.whatsapp;
        entry.img_folder = match.img_folder;
        entry.img_name = match.img_name;
      } else {
        entry.removed = true;
      }
    }
    saveCart();
    renderCart();
  }

  function renderFoods(){
    const grid = document.getElementById('food-grid');
    grid.innerHTML = '';
    foods.forEach(f => {
      const card = document.createElement('div');
      card.className = 'food-card';
      const imgWrap = document.createElement('div'); imgWrap.className='food-img';
      const img = document.createElement('img');
      const imgPath = makeImagePath(f);
      img.src = imgPath;
      img.onerror = () => img.src = PLACEHOLDER;
      img.alt = f.fa || f.en;
      imgWrap.appendChild(img);

      const info = document.createElement('div'); info.className='food-info';
      const h = document.createElement('h3'); h.textContent = f.fa || f.en;
      const p = document.createElement('p'); p.textContent = f.ingredients || '';
      const controls = document.createElement('div'); controls.className='controls';
      const priceSpan = document.createElement('div'); priceSpan.className='price'; priceSpan.textContent = formatMoney(f.price) + ' ØªÙˆÙ…Ø§Ù†';
      const addBtn = document.createElement('button'); addBtn.className='add-btn'; addBtn.textContent='Ø§ÙØ²ÙˆØ¯Ù†';
      addBtn.addEventListener('click', ()=> addToCart(f));
      controls.appendChild(priceSpan);
      controls.appendChild(addBtn);

      info.appendChild(h); info.appendChild(p); info.appendChild(controls);
      card.appendChild(imgWrap); card.appendChild(info);
      grid.appendChild(card);
    });
  }

  function makeImagePath(f){
    let folder = (f.img_folder || '').trim();
    let name = (f.img_name || '').trim();
    if(folder && name){
      folder = folder.replace(/\s+$/,'').replace(/\\/g,'/').replace(/\s+/g,' ');
      let path = folder + (folder.endsWith('/') ? '' : '/') + name;
      return encodeURI(path);
    }
    return PLACEHOLDER;
  }

  function formatMoney(num){
    if(!num && num !== 0) return '0';
    try{
      return Number(num).toLocaleString('en-US');
    }catch(e){ return String(num); }
  }

  // Cart operations
  function addToCart(food){
    const id = food.id || (food.en||food.fa).toString().trim();
    if(!cart[id]) cart[id] = Object.assign({}, food, {qid:id, qty:0});
    cart[id].qty += 1;
    delete cart[id].removed;
    saveCart();
    renderCart();
  }
  function removeFromCart(id){
    delete cart[id];
    saveCart();
    renderCart();
  }
  function changeQty(id, delta){
    if(!cart[id]) return;
    cart[id].qty += delta;
    if(cart[id].qty <= 0) delete cart[id];
    saveCart();
    renderCart();
  }
  function saveCart(){
    try{
      localStorage.setItem('toucan_cart', JSON.stringify(cart));
    }catch(e){}
  }
  function loadCart(){
    try{
      const raw = localStorage.getItem('toucan_cart');
      if(raw) cart = JSON.parse(raw);
    }catch(e){ cart = {}; }
  }
  function clearCart(){
    cart = {};
    saveCart();
    renderCart();
  }

  function renderCart(){
    const list = document.getElementById('cart-list');
    list.innerHTML = '';
    let total = 0, count = 0;
    for(const id in cart){
      const it = cart[id];
      count += it.qty;
      total += (Number(it.price)||0) * it.qty;
      const row = document.createElement('div'); row.className='cart-item';
      const name = document.createElement('div'); name.style.flex='1'; name.textContent = (it.fa||it.en) + (it.removed ? ' (Ø­Ø°Ùâ€ŒØ´Ø¯Ù‡ Ø§Ø² Ù…Ù†Ùˆ)' : '');
      const qty = document.createElement('div'); qty.className='qty'; qty.textContent = it.qty + 'x';
      const plus = document.createElement('button'); plus.textContent='+'; plus.addEventListener('click', ()=> changeQty(id,1));
      const minus = document.createElement('button'); minus.textContent='-'; minus.addEventListener('click', ()=> changeQty(id,-1));
      const rem = document.createElement('button'); rem.textContent='Ø­Ø°Ù'; rem.addEventListener('click', ()=> removeFromCart(id));
      row.appendChild(name); row.appendChild(qty); row.appendChild(plus); row.appendChild(minus); row.appendChild(rem);
      list.appendChild(row);
    }
    document.getElementById('cart-total').textContent = formatMoney(total);
    document.getElementById('cart-count').textContent = count;
  }

  // Build whatsapp messages grouped by number
  function buildMessages(){
    const groups = {};
    for(const id in cart){
      const it = cart[id];
      if(!it.whatsapp) it.whatsapp = '';
      const num = sanitizeNumber(it.whatsapp || '');
      const key = num || '__NO_NUM__';
      if(!groups[key]) groups[key] = {num: num, items: [], subtotal:0};
      groups[key].items.push(it);
      groups[key].subtotal += (Number(it.price)||0) * it.qty;
    }
    const messages = [];
    for(const k in groups){
      const g = groups[k];
      let lines = [];
      lines.push('Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯ - TOUCAN');
      lines.push('Ù…ÛŒØ²: ' + (table || 'â€”'));
      lines.push('');
      g.items.forEach(it => {
        lines.push(it.qty + ' x ' + (it.fa||it.en) + ' - ' + formatMoney(it.price) + ' ØªÙˆÙ…Ø§Ù†');
      });
      lines.push('');
      lines.push('Ù…Ø¬Ù…ÙˆØ¹: ' + formatMoney(g.subtotal) + ' ØªÙˆÙ…Ø§Ù†');
      const txt = lines.join('\n');
      messages.push({to: g.num, text: txt, items: g.items, subtotal: g.subtotal});
    }
    return messages;
  }

  function sanitizeNumber(n){
    if(!n) return '';
    return String(n).replace(/[^0-9]/g,'');
  }

  function sendToWhatsApp(){
    const msgs = buildMessages();
    if(msgs.length === 0) { alert('Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª'); return; }
    if(msgs.length === 1){
      const m = msgs[0];
      if(!m.to){
        promptAndOpen(m.text);
        saveOrderForKitchen(m);
      } else {
        const url = 'https://wa.me/' + m.to + '?text=' + encodeURIComponent(m.text);
        window.open(url, '_blank');
        saveOrderForKitchen(m);
      }
      clearCart(); // ğŸŸ¢ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø³Ø¨Ø¯ Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ø±Ø³Ø§Ù„
      return;
    }
    const modal = document.getElementById('modal');
    const list = document.getElementById('recipient-list');
    list.innerHTML = '';
    msgs.forEach(m => {
      const div = document.createElement('div');
      const label = document.createElement('div'); label.textContent = (m.to || '(Ø¨Ø¯ÙˆÙ† Ø´Ù…Ø§Ø±Ù‡)') + ' â€” Ù…Ø¬Ù…ÙˆØ¹: ' + formatMoney(m.subtotal) + ' ØªÙˆÙ…Ø§Ù†';
      const btn = document.createElement('button'); btn.className='send-btn'; btn.textContent='Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ' + (m.to || '(ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯)');
      btn.addEventListener('click', ()=> {
        if(!m.to) { promptAndOpen(m.text); saveOrderForKitchen(m); }
        else { window.open('https://wa.me/' + m.to + '?text=' + encodeURIComponent(m.text), '_blank'); saveOrderForKitchen(m); }
        clearCart(); // ğŸŸ¢ Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ØŒ Ø®Ø§Ù„ÛŒ Ú©Ù†
      });
      div.appendChild(label); div.appendChild(btn);
      list.appendChild(div);
    });
    modal.style.display = 'flex';
    document.getElementById('close-modal').onclick = ()=> modal.style.display='none';
    document.getElementById('send-all').onclick = ()=> {
      msgs.forEach(m=>{
        if(m.to) window.open('https://wa.me/' + m.to + '?text=' + encodeURIComponent(m.text), '_blank');
        else promptAndOpen(m.text);
        saveOrderForKitchen(m);
      });
      clearCart(); // ğŸŸ¢ Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ù‡Ù…Ù‡ØŒ Ø®Ø§Ù„ÛŒ Ú©Ù†
      modal.style.display='none';
    };
  }

  function promptAndOpen(text){
    const number = prompt('Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§ØªØ³â€ŒØ§Ù¾ Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 98912...)');
    if(number){
      const num = sanitizeNumber(number);
      window.open('https://wa.me/' + num + '?text=' + encodeURIComponent(text), '_blank');
    } else {
      alert('Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯. Ø§Ø±Ø³Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯.');
    }
  }

  function saveOrderForKitchen(message){
    try{
      const raw = localStorage.getItem('toucan_orders') || '[]';
      const orders = JSON.parse(raw);
      orders.unshift({to: message.to, text: message.text, items: message.items, subtotal: message.subtotal, table: table, ts: Date.now()});
      localStorage.setItem('toucan_orders', JSON.stringify(orders.slice(0,200)));
    }catch(e){ console.warn(e); }
  }

  loadCart();
  fetchFoods();
  renderCart();
  setInterval(fetchFoods, POLL_INTERVAL);

  document.getElementById('send-whatsapp').addEventListener('click', sendToWhatsApp);
  document.getElementById('clear-cart').addEventListener('click', ()=> {
    if(confirm('Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø§Ù…Ù„ ÙØ§Ú©ØªÙˆØ±ØŸ')) clearCart();
  });
  document.getElementById('modal').addEventListener('click', (ev)=>{
    if(ev.target === document.getElementById('modal')) document.getElementById('modal').style.display='none';
  });

})();
</script>
</body>
</html>
