
/* app.js */
const DATA_CSV = 'data/foods.csv';
let foods = [];
let order = JSON.parse(localStorage.getItem('toucan_order')||'[]');

function parseCsvText(text){ return Papa.parse(text, {header:true,skipEmptyLines:true}).data; }

async function fetchFoodsText(){ const res = await fetch(DATA_CSV + '?t=' + Date.now()); if(!res.ok) throw new Error('Failed to fetch foods.csv'); return await res.text(); }

async function loadFoods(){ try{ const txt = await fetchFoodsText(); const parsed = parseCsvText(txt); foods = parsed.map(r=>({ en_name: r['en_name']||r['A']||'', fa_name: r['fa_name']||r['B']||'', ingredients: r['ingredients']||r['C']||'', price: r['price']||r['D']||'', whatsapp: r['whatsapp']||r['E']||'', image_name: r['image_name']||r['F']||'', image_path: r['image_path']||r['G']||'' })); renderMenu(); }catch(e){ console.error(e); document.getElementById('menu').innerHTML = '<p style="color:#fff;padding:20px">خطا در بارگذاری منو. لطفاً فایل data/foods.csv را کنترل کنید.</p>'; } }

function getQueryParam(name){ return new URLSearchParams(location.search).get(name); }

function createCard(food){ const div = document.createElement('div'); div.className='card'; const circle = document.createElement('div'); circle.className='food-circle'; const img = document.createElement('img'); let src = food.image_path && food.image_path.trim()!=='' ? food.image_path : ('foods/' + (food.image_name||'placeholder.svg')); img.src = src; img.alt = food.fa_name || food.en_name; circle.appendChild(img); const h3 = document.createElement('h3'); h3.textContent = food.fa_name || food.en_name; const ing = document.createElement('p'); ing.className='ing'; ing.textContent = food.ingredients || ''; const price = document.createElement('p'); price.className='price'; price.textContent = food.price ? (food.price + ' تومان') : 'قیمت: ---'; const actions = document.createElement('div'); actions.className='actions'; const addBtn = document.createElement('button'); addBtn.className='btn'; addBtn.textContent='افزودن به سفارش'; addBtn.onclick = ()=>{ addToOrder(food); }; actions.appendChild(addBtn); div.appendChild(circle); div.appendChild(h3); div.appendChild(ing); div.appendChild(price); div.appendChild(actions); return div; }

function renderMenu(){ const menu = document.getElementById('menu'); menu.innerHTML=''; foods.forEach(f=> menu.appendChild(createCard(f)) ); renderOrder(); }

function addToOrder(food){ const existing = order.find(i=>i.name===food.fa_name); if(existing){ existing.qty += 1; } else { order.push({ name: food.fa_name, price: food.price||'', qty:1, whatsapp: food.whatsapp||'' }); } saveAndRender(); }

function removeFromOrder(name){ order = order.filter(i=>i.name!==name); saveAndRender(); }

function changeQty(name, qty){ const item = order.find(i=>i.name===name); if(item){ item.qty = qty; if(item.qty<=0) removeFromOrder(name); else saveAndRender(); } }

function renderOrder(){ const ul = document.getElementById('orderList'); ul.innerHTML=''; order.forEach(it=>{ const li = document.createElement('li'); li.innerHTML = `<span>${it.name} × ${it.qty} ${(it.price?('<small>'+it.price+'تومان</small>'):'' )}</span>`; const btns = document.createElement('div'); btns.style.display='flex'; btns.style.gap='6px'; const minus = document.createElement('button'); minus.textContent='−'; minus.className='btn small'; minus.onclick=()=>{ changeQty(it.name, it.qty-1); }; const plus = document.createElement('button'); plus.textContent='+'; plus.className='btn small'; plus.onclick=()=>{ changeQty(it.name, it.qty+1); }; const del = document.createElement('button'); del.textContent='حذف'; del.className='btn small'; del.onclick=()=>{ removeFromOrder(it.name); }; btns.appendChild(minus); btns.appendChild(plus); btns.appendChild(del); li.appendChild(btns); ul.appendChild(li); }); const totalDiv = document.getElementById('orderTotal'); const total = order.reduce((s,i)=> s + (i.qty * (parseFloat(i.price)||0)), 0); totalDiv.textContent = 'مجموع: ' + (total>0? total+' تومان' : '—'); }

function saveAndRender(){ localStorage.setItem('toucan_order', JSON.stringify(order)); renderOrder(); }

document.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('clearOrder').addEventListener('click', ()=>{ order=[]; saveAndRender(); }); document.getElementById('sendOrder').addEventListener('click', ()=>{ if(order.length===0){ alert('سفارشی انتخاب نشده است'); return; } const table = getQueryParam('table') || 'ناشناخته'; let msg = `🍽️ سفارش جدید از TOUCAN\n`; msg += `میز: ${table}\n`; order.forEach((it, idx)=>{ msg += `${idx+1}) ${it.name} × ${it.qty}` + (it.price?(' — '+it.price+' تومان'):'') + '\n'; }); const total = order.reduce((s,i)=> s + (i.qty * (parseFloat(i.price)||0)), 0); if(total>0) msg += `مجموع: ${total} تومان\n`; msg += 'لطفا آماده کنید ✅'; const log = JSON.parse(localStorage.getItem('toucan_orders_log')||'[]'); log.push({table:table, items:order, time: new Date().toLocaleString()}); localStorage.setItem('toucan_orders_log', JSON.stringify(log)); const firstWithPhone = order.find(it=> it.whatsapp && it.whatsapp.trim().length>0); const phoneRaw = firstWithPhone ? firstWithPhone.whatsapp : ''; const phone = phoneRaw.replace(/[^\d+]/g,'').replace(/^\+/,'') || '989362929909'; const waLink = 'https://wa.me/' + phone + '?text=' + encodeURIComponent(msg); window.open(waLink,'_blank'); }); loadFoods(); let last = null; setInterval(async ()=>{ try{ const res = await fetch(DATA_CSV + '?t='+Date.now()); const txt = await res.text(); if(last && txt!==last){ const parsed = parseCsvText(txt); const newFoods = parsed.map(r=>({ en_name: r['en_name']||r['A']||'', fa_name: r['fa_name']||r['B']||'', ingredients: r['ingredients']||r['C']||'', price: r['price']||r['D']||'', whatsapp: r['whatsapp']||r['E']||'', image_name: r['image_name']||r['F']||'', image_path: r['image_path']||r['G']||'' })); foods = newFoods; renderMenu(); } last = txt; }catch(e){} },10000); });
